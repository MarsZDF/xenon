# Xenon

A robust, zero-dependency Python library for cleaning up malformed XML generated by Large Language Models (LLMs).

## Features

- **Zero Dependencies**: Uses only Python Standard Library
- **Stack-based Parser**: Deterministic handling of nested structures and truncation
- **LLM-Focused**: Specifically designed to handle common LLM XML generation failures
- **Robust Error Handling**: Production-ready with comprehensive validation and error recovery
- **Multiple Modes**: Choose between strict, default, or lenient error handling
- **Simple Interface**: Easy-to-use functions for common use cases

## Installation

```bash
pip install xenon
```

## Quick Start

```python
from xenon import repair_xml, parse_xml

# Repair malformed XML
malformed = 'Sure, here is the XML: <root><user name=john'
repaired = repair_xml(malformed)
print(repaired)  # <root><user name="john"></user></root>

# Parse to dictionary
result = parse_xml(malformed)
print(result)    # {'root': {'user': {'@attributes': {'name': 'john'}}}}
```

## Supported Failure Modes

### 1. Truncation/Cut-off
When LLMs run out of tokens mid-tag:
```python
malformed = '<root><user name="alice"'
repaired = repair_xml(malformed)
# Result: <root><user name="alice"></user></root>
```

### 2. Conversational Fluff
XML embedded in conversational text:
```python
malformed = 'Here is your XML data:\n<root><message>Hello</message></root>\nHope this helps!'
repaired = repair_xml(malformed)
# Result: <root><message>Hello</message></root>
```

### 3. Malformed Attributes
Missing quotes around attribute values:
```python
malformed = '<item id=123 type=product name=widget>'
repaired = repair_xml(malformed)
# Result: <item id="123" type="product" name="widget"></item>
```

### 4. Unescaped Entities
Unescaped `&` or `<` in text content:
```python
malformed = '<desc>Barnes & Noble sells books < $20</desc>'
repaired = repair_xml(malformed)
# Result: <desc>Barnes &amp; Noble sells books &lt; $20</desc>
```

### 5. Code Content (CDATA)
Automatically wrap code and special content in CDATA sections:
```python
malformed = '<code>function test() { return x && y; }</code>'
repaired = repair_xml(malformed)
# Result: <code><![CDATA[function test() { return x && y; }]]></code>
```

### 6. Mismatched Tag Case
Case-insensitive tag matching (uses opening tag's case):
```python
malformed = '<Root><Item>text</item></Root>'
repaired = repair_xml(malformed)
# Result: <Root><Item>text</Item></Root>
```

### 7. Missing Namespace Declarations
Auto-inject common namespace declarations:
```python
malformed = '<soap:Envelope><soap:Body>test</soap:Body></soap:Envelope>'
repaired = repair_xml(malformed)
# Result: <soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
#         <soap:Body>test</soap:Body></soap:Envelope>
```

### 8. Duplicate Attributes
Remove duplicate attributes (keeps first occurrence):
```python
malformed = '<item id="1" name="foo" id="2">'
repaired = repair_xml(malformed)
# Result: <item id="1" name="foo"></item>
```

## Error Handling

Xenon provides three different modes for different use cases:

### Safe Mode (Recommended for Production)

Use `repair_xml_safe()` for robust error handling with helpful error messages:

```python
from xenon import repair_xml_safe, ValidationError

try:
    result = repair_xml_safe(llm_output)
except ValidationError as e:
    print(f"Invalid input: {e}")
    result = default_xml
```

**Features:**
- Input validation (type checking, size limits)
- Helpful error messages
- Optional strict mode for output validation
- Configurable empty string handling

**Parameters:**
- `xml_string`: The XML string to repair
- `strict`: If True, validate repaired output (default: False)
- `allow_empty`: If True, accept empty strings (default: False)
- `max_size`: Maximum input size in bytes (default: 100MB, None = unlimited)

```python
# Strict mode - validates output structure
result = repair_xml_safe('<root><item>', strict=True)

# Allow empty input
result = repair_xml_safe('', allow_empty=True)  # Returns ''

# Custom size limit
result = repair_xml_safe(large_xml, max_size=10_000_000)  # 10MB limit
```

### Lenient Mode (Never Raises)

Use `repair_xml_lenient()` when you want maximum fault tolerance:

```python
from xenon import repair_xml_lenient

# Always returns a string, never raises
result = repair_xml_lenient(None)  # Returns ''
result = repair_xml_lenient(123)   # Returns '123'
result = repair_xml_lenient('<root><item')  # Returns '<root><item></item></root>'
```

**Perfect for:**
- Batch processing with mixed data quality
- When you prefer empty results over exceptions
- Rapid prototyping

### Default Mode (Original Behavior)

The original `repair_xml()` function is still available and works as before:

```python
from xenon import repair_xml

result = repair_xml('<root><item>')  # Works as always
```

**Note:** This function does not validate input types - passing `None` or non-string values will cause errors.

### Exception Hierarchy

All Xenon errors inherit from `XenonException`:

```python
from xenon import XenonException, ValidationError, RepairError

try:
    result = repair_xml_safe(xml_string)
except ValidationError as e:
    # Input was invalid (wrong type, too large, etc.)
    print(f"Validation failed: {e}")
except RepairError as e:
    # Internal error during repair
    print(f"Repair failed: {e}")
except XenonException as e:
    # Catch all Xenon errors
    print(f"Xenon error: {e}")
```

**Exception Types:**
- `XenonException`: Base exception for all Xenon errors
- `ValidationError`: Invalid input (wrong type, empty, too large)
- `MalformedXMLError`: Output still invalid in strict mode
- `RepairError`: Internal error during repair process

## Function Reference

### Core Functions

#### `repair_xml(xml_string: str) -> str`

Original repair function without error handling.

**Parameters:**
- `xml_string`: The potentially malformed XML string

**Returns:**
- A well-formed XML string

**Note:** No input validation - use `repair_xml_safe()` for production.

---

#### `parse_xml(xml_string: str) -> dict`

Repairs and parses malformed XML to a dictionary.

**Parameters:**
- `xml_string`: The potentially malformed XML string

**Returns:**
- A nested dictionary representation of the XML

**Dictionary Structure:**
- Element text content: stored as string value or `#text` key
- Attributes: stored under `@attributes` key
- Multiple elements with same name: converted to list

---

### Safe Functions (Recommended)

#### `repair_xml_safe(xml_string, strict=False, allow_empty=False, max_size=None) -> str`

Safely repair XML with comprehensive error handling.

**Parameters:**
- `xml_string` (str): The XML string to repair
- `strict` (bool): Validate output structure (default: False)
- `allow_empty` (bool): Accept empty input (default: False)
- `max_size` (int): Max size in bytes, None = unlimited (default: 100MB)

**Returns:**
- Repaired XML string

**Raises:**
- `ValidationError`: Invalid input
- `MalformedXMLError`: Invalid output (strict mode only)
- `RepairError`: Internal repair error

---

#### `parse_xml_safe(xml_string, strict=False, allow_empty=False, max_size=None) -> dict`

Safely parse malformed XML to dictionary.

**Parameters:**
- Same as `repair_xml_safe()`

**Returns:**
- Dictionary representation of the XML

**Raises:**
- Same exceptions as `repair_xml_safe()`

---

### Lenient Functions (Never Raise)

#### `repair_xml_lenient(xml_input) -> str`

Repair XML in lenient mode - never raises exceptions.

**Parameters:**
- `xml_input` (Any): Any input (None, int, list, str, etc.)

**Returns:**
- Repaired XML string, or empty string on any error

---

#### `parse_xml_lenient(xml_input) -> dict`

Parse XML in lenient mode - never raises exceptions.

**Parameters:**
- `xml_input` (Any): Any input

**Returns:**
- Dictionary representation, or empty dict on any error

## Try It Out

**Interactive Notebook**: Try Xenon in your browser with our Google Colab notebook - no installation required!

[![Open In Colab](https://colab.research.google.com/assets/colab-badge.svg)](https://colab.research.google.com/github/MarsZDF/xenon/blob/main/xenon_demo.ipynb)

## Development

```bash
# Clone the repository
git clone https://github.com/xenon-xml/xenon.git
cd xenon

# Install development dependencies
pip install -e ".[dev]"

# Run tests (13 essential tests)
python -m pytest tests/

# Run specific test file
python -m pytest tests/test_core.py -v
```

## License

MIT License - see LICENSE file for details.

## Contributing

Contributions are welcome! Please feel free to submit a Pull Request.